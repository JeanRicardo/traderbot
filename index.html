<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Dashboard Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        background: '#0d0d0d',
                        surface: '#1a1a1a',
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#22c55e',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        border: '#262626'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d;
            color: #e5e5e5;
        }
        .glass-panel {
            background: rgba(26, 26, 26, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .sidebar-item {
            transition: all 0.2s ease;
        }
        .sidebar-item:hover, .sidebar-item.active {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-right: 3px solid #3b82f6;
        }
        .card-hover {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0d0d0d;
        }
        ::-webkit-scrollbar-thumb {
            background: #262626;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #404040;
        }
        
        /* Mobile Sidebar Transition */
        @media (max-width: 768px) {
            #sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                position: fixed;
                height: 100%;
                z-index: 50;
            }
            #sidebar.open {
                transform: translateX(0);
            }
            #overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 40;
                backdrop-filter: blur(4px);
            }
            #overlay.active {
                display: block;
            }
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- Mobile Overlay -->
    <div id="overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-surface border-r border-border flex flex-col z-50 md:relative md:translate-x-0">
        <div class="p-6 border-b border-border flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center shadow-lg shadow-primary/20">
                    <i class="fa-solid fa-robot text-white text-sm"></i>
                </div>
                <h1 class="font-bold text-lg tracking-tight">Robot<span class="text-primary">Dash</span></h1>
            </div>
            <!-- Close button for mobile -->
            <button onclick="toggleSidebar()" class="md:hidden text-secondary hover:text-white">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>

        <nav class="flex-1 overflow-y-auto py-4">
            <div class="px-4 mb-2 text-xs font-semibold text-secondary uppercase tracking-wider">Menu Principal</div>
            <a href="#" onclick="showPage('dashboard'); closeSidebarMobile()" id="nav-dashboard" class="sidebar-item active flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-300 hover:text-white">
                <i class="fa-solid fa-chart-line w-5"></i> Dashboard
            </a>
            <a href="#" onclick="showPage('wealth'); closeSidebarMobile()" id="nav-wealth" class="sidebar-item flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-300 hover:text-white">
                <i class="fa-solid fa-sack-dollar w-5"></i> Gestão de Patrimônio
            </a>
            <a href="#" onclick="showPage('results'); closeSidebarMobile()" id="nav-results" class="sidebar-item flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-300 hover:text-white">
                <i class="fa-solid fa-trophy w-5"></i> Resultados
            </a>
            <a href="#" onclick="checkAdminAccess(); closeSidebarMobile()" id="nav-admin" class="sidebar-item flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-300 hover:text-white">
                <i class="fa-solid fa-lock w-5"></i> Administração
            </a>

            <div class="mt-8 px-4 mb-2 text-xs font-semibold text-secondary uppercase tracking-wider">Robôs Ativos</div>
            <div id="robot-list" class="space-y-1">
                <!-- Lista de robôs será gerada via JS -->
            </div>
        </nav>

        <div class="p-4 border-t border-border bg-surface/50 space-y-3">
            <!-- Cotação USD -->
            <div>
                <div class="flex items-center justify-between mb-1">
                    <span class="text-xs text-secondary font-medium">USD/BRL</span>
                    <button onclick="updateRates()" class="text-xs text-primary hover:underline flex items-center gap-1">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2 bg-background rounded-md p-2 border border-border">
                    <span class="text-secondary text-sm">R$</span>
                    <input type="number" id="dollar-rate" value="5.00" step="0.01" class="bg-transparent text-sm font-mono w-full focus:outline-none text-white" onchange="manualUpdateRate('usd', this.value)">
                </div>
            </div>
            
            <!-- Cotação EUR -->
            <div>
                <div class="flex items-center justify-between mb-1">
                    <span class="text-xs text-secondary font-medium">EUR/BRL</span>
                </div>
                <div class="flex items-center gap-2 bg-background rounded-md p-2 border border-border">
                    <span class="text-secondary text-sm">R$</span>
                    <input type="number" id="euro-rate" value="5.50" step="0.01" class="bg-transparent text-sm font-mono w-full focus:outline-none text-white" onchange="manualUpdateRate('eur', this.value)">
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden relative w-full">
        <!-- Header -->
        <header class="h-16 bg-surface/80 backdrop-blur-md border-b border-border flex items-center justify-between px-4 md:px-8 z-10 shrink-0">
            <div class="flex items-center gap-4">
                <!-- Mobile Menu Button -->
                <button onclick="toggleSidebar()" class="md:hidden text-white p-2 -ml-2">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <h2 id="page-title" class="text-lg md:text-xl font-semibold text-white truncate">Dashboard Geral</h2>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="text-sm text-secondary hidden md:block">
                    <i class="fa-regular fa-calendar mr-2"></i> <span id="current-date"></span>
                </div>
                <div class="h-8 w-8 rounded-full bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center text-xs font-bold text-white shadow-lg">
                    AD
                </div>
            </div>
        </header>

        <!-- Content Pages -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 relative w-full">
            
            <!-- Dashboard Page -->
            <div id="page-dashboard" class="space-y-6 animate-fade-in pb-20 md:pb-0">
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                    <div class="glass-panel rounded-xl p-6 card-hover border-l-4 border-primary">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm text-secondary font-medium">Lucro Total (USD)</p>
                                <h3 class="text-2xl font-bold text-white mt-1" id="kpi-profit">$ 0.00</h3>
                            </div>
                            <div class="p-2 bg-primary/10 rounded-lg text-primary">
                                <i class="fa-solid fa-dollar-sign"></i>
                            </div>
                        </div>
                        <div class="text-xs text-success flex items-center gap-1">
                            <i class="fa-solid fa-arrow-trend-up"></i> <span id="kpi-profit-growth">+0%</span> vs mês anterior
                        </div>
                    </div>

                    <div class="glass-panel rounded-xl p-6 card-hover border-l-4 border-green-500">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm text-secondary font-medium">Lucro em Reais</p>
                                <h3 class="text-2xl font-bold text-white mt-1" id="kpi-profit-brl">R$ 0,00</h3>
                            </div>
                            <div class="p-2 bg-green-500/10 rounded-lg text-green-500">
                                <span class="font-bold text-lg">R$</span>
                            </div>
                        </div>
                        <div class="text-xs text-secondary">Conversão direta</div>
                    </div>

                    <div class="glass-panel rounded-xl p-6 card-hover border-l-4 border-purple-500">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm text-secondary font-medium">Investimento (USD)</p>
                                <h3 class="text-2xl font-bold text-white mt-1" id="kpi-investment">$ 0.00</h3>
                            </div>
                            <div class="p-2 bg-purple-500/10 rounded-lg text-purple-500">
                                <i class="fa-solid fa-sack-dollar"></i>
                            </div>
                        </div>
                        <div class="text-xs text-secondary">Total investido</div>
                    </div>

                    <div class="glass-panel rounded-xl p-6 card-hover border-l-4 border-warning">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm text-secondary font-medium">Win Rate</p>
                                <h3 class="text-2xl font-bold text-white mt-1" id="kpi-winrate">0%</h3>
                            </div>
                            <div class="p-2 bg-warning/10 rounded-lg text-warning">
                                <i class="fa-solid fa-crosshairs"></i>
                            </div>
                        </div>
                        <div class="text-xs text-secondary">Taxa de acerto média</div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="glass-panel rounded-xl p-6 lg:col-span-2">
                        <h3 class="text-lg font-bold text-white mb-4">Evolução de Lucro (USD)</h3>
                        <div class="h-64 md:h-80">
                            <canvas id="profitChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-panel rounded-xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4">Comparativo ROI</h3>
                        <div class="h-64 md:h-80">
                            <canvas id="roiChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="glass-panel rounded-xl overflow-hidden">
                    <div class="p-6 border-b border-border">
                        <h3 class="text-lg font-bold text-white">Detalhamento por Período</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-secondary uppercase bg-white/5">
                                <tr>
                                    <th class="px-6 py-3">Robô</th>
                                    <th class="px-6 py-3">Configuração</th>
                                    <th class="px-6 py-3">Mês</th>
                                    <th class="px-6 py-3 text-right">Invest. (USD)</th>
                                    <th class="px-6 py-3 text-right">Lucro (USD)</th>
                                    <th class="px-6 py-3 text-right">ROI</th>
                                    <th class="px-6 py-3 text-center">Win Rate</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-table-body" class="divide-y divide-border">
                                <!-- Rows generated via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Wealth Management Page (NEW) -->
            <div id="page-wealth" class="space-y-6 hidden animate-fade-in pb-20 md:pb-0">
                <!-- Wealth Header -->
                <div class="glass-panel rounded-xl p-6 border-l-4 border-primary">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-white">Patrimônio Total</h2>
                            <p class="text-secondary text-sm">Soma de todas as contas e robôs</p>
                        </div>
                        <div class="text-right">
                            <h3 class="text-3xl font-bold text-success" id="wealth-total">$ 0.00</h3>
                            <p class="text-sm text-secondary" id="wealth-total-brl">R$ 0,00</p>
                        </div>
                    </div>
                </div>

                <!-- Goals Progress -->
                <div class="glass-panel rounded-xl p-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-white">Meta Principal: <span id="goal-target-display">$100k</span></h3>
                        <button onclick="editGoal()" class="text-xs text-primary hover:underline">Editar Meta</button>
                    </div>
                    <div class="w-full bg-surface rounded-full h-4 mb-2 border border-border overflow-hidden">
                        <div id="goal-progress-bar" class="bg-gradient-to-r from-primary to-purple-600 h-4 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-secondary">
                        <span id="goal-current">$ 0</span>
                        <span id="goal-percentage">0%</span>
                    </div>
                </div>

                <!-- Wealth Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Equity Curve Projection -->
                    <div class="glass-panel rounded-xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4">Projeção de Juros Compostos</h3>
                        <div class="h-64">
                            <canvas id="wealthProjectionChart"></canvas>
                        </div>
                        <div class="mt-4 flex gap-4 text-xs justify-center">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-primary rounded-full"></div>
                                <span class="text-secondary">Realizado</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-purple-500 rounded-full border border-dashed border-white/50"></div>
                                <span class="text-secondary">Projetado (5%/mês)</span>
                            </div>
                        </div>
                    </div>

                    <!-- House Money Indicator -->
                    <div class="glass-panel rounded-xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4">House Money (Risco vs Lucro)</h3>
                        <div class="h-64 flex items-center justify-center">
                            <canvas id="houseMoneyChart"></canvas>
                        </div>
                        <p class="text-center text-xs text-secondary mt-2">Quanto do seu patrimônio é lucro reinvestido vs dinheiro do bolso.</p>
                    </div>
                </div>

                <!-- Accounts Breakdown -->
                <div class="glass-panel rounded-xl overflow-hidden">
                    <div class="p-6 border-b border-border flex justify-between items-center">
                        <h3 class="text-lg font-bold text-white">Contas & Corretoras</h3>
                        <button onclick="openModal('account-modal')" class="bg-primary hover:bg-blue-600 text-white px-3 py-1.5 rounded text-xs font-medium transition-colors">
                            <i class="fa-solid fa-plus mr-1"></i> Nova Conta
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-secondary uppercase bg-white/5">
                                <tr>
                                    <th class="px-6 py-3">Conta / Corretora</th>
                                    <th class="px-6 py-3 text-right">Saldo Inicial</th>
                                    <th class="px-6 py-3 text-right">Aportes</th>
                                    <th class="px-6 py-3 text-right">Lucro Acumulado</th>
                                    <th class="px-6 py-3 text-right">Saldo Atual</th>
                                    <th class="px-6 py-3 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="wealth-accounts-body" class="divide-y divide-border">
                                <!-- Generated via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Results Page -->
            <div id="page-results" class="hidden space-y-6 animate-fade-in pb-20 md:pb-0">
                <div id="top-robots-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 pt-6">
                    <!-- Podium cards generated via JS -->
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-panel rounded-xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4">Ranking de Lucratividade</h3>
                        <div class="h-64">
                            <canvas id="rankingChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-panel rounded-xl p-6">
                        <h3 class="text-lg font-bold text-white mb-4">Risco x Retorno</h3>
                        <div class="h-64">
                            <canvas id="scatterChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Page -->
            <div id="page-admin" class="hidden space-y-6 animate-fade-in pb-20 md:pb-0">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-white">Gerenciar Robôs</h2>
                    <div class="flex gap-2">
                        <button onclick="exportData()" class="bg-secondary/20 hover:bg-secondary/40 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                            <i class="fa-solid fa-download"></i> Backup
                        </button>
                        <label for="import-file" class="bg-secondary/20 hover:bg-secondary/40 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 cursor-pointer">
                            <i class="fa-solid fa-upload"></i> Restaurar
                        </label>
                        <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                        
                        <button onclick="openModal('robot-modal')" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-lg shadow-primary/20">
                            <i class="fa-solid fa-plus mr-2"></i> Novo Robô
                        </button>
                    </div>
                </div>

                <div id="admin-list" class="grid grid-cols-1 gap-4">
                    <!-- Admin cards generated via JS -->
                </div>
            </div>

        </div>
    </main>

    <!-- Modals -->
    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-8 rounded-2xl border border-white/10 shadow-2xl transform transition-all scale-100">
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-primary rounded-xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-primary/20">
                    <i class="fa-solid fa-lock text-white text-xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-white">Acesso Restrito</h2>
                <p class="text-secondary text-sm mt-1">Área administrativa protegida</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-secondary mb-1 uppercase tracking-wider">Senha de Acesso</label>
                    <input type="password" id="admin-password" class="w-full bg-background border border-border rounded-lg px-4 py-3 text-white focus:outline-none focus:border-primary transition-colors" placeholder="••••••••">
                    <p id="login-error" class="text-danger text-xs mt-2 hidden flex items-center gap-1"><i class="fa-solid fa-circle-exclamation"></i> Senha incorreta</p>
                </div>
                <button onclick="verifyPassword()" class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition-all shadow-lg shadow-primary/20">
                    Entrar
                </button>
            </div>
        </div>
    </div>

    <!-- Robot Modal -->
    <div id="robot-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-2xl p-6 rounded-2xl border border-white/10 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white" id="modal-title">Novo Robô</h3>
                <button onclick="closeModal('robot-modal')" class="text-secondary hover:text-white">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="robot-form" onsubmit="saveRobot(event)" class="space-y-4">
                <input type="hidden" id="robot-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-secondary mb-1">Nome do Robô</label>
                        <input type="text" id="robot-name" required class="w-full bg-background border border-border rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-secondary mb-1">Cor de Identificação</label>
                        <input type="color" id="robot-color" value="#3b82f6" class="w-full h-10 bg-background border border-border rounded-lg cursor-pointer">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-secondary mb-1">Descrição</label>
                    <textarea id="robot-desc" rows="2" class="w-full bg-background border border-border rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary"></textarea>
                </div>

                <!-- Configs Section -->
                <div class="bg-white/5 p-4 rounded-lg border border-white/5">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-medium text-secondary uppercase">Configurações (Lote / Timeframe)</label>
                        <button type="button" onclick="addConfigRow()" class="text-xs text-primary hover:underline">+ Adicionar</button>
                    </div>
                    <div id="configs-container" class="space-y-2">
                        <!-- Config rows added via JS -->
                    </div>
                </div>

                <div class="bg-white/5 p-4 rounded-lg border border-white/5">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-medium text-secondary uppercase">Histórico Mensal</label>
                        <button type="button" onclick="addDataRow()" class="text-xs text-primary hover:underline">+ Adicionar Mês</button>
                    </div>
                    <div id="data-rows" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                        <!-- Data rows added via JS -->
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4 border-t border-border">
                    <button type="button" onclick="closeModal('robot-modal')" class="px-4 py-2 text-sm font-medium text-gray-300 hover:text-white">Cancelar</button>
                    <button type="submit" class="bg-primary hover:bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-lg shadow-primary/20">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Account Modal (NEW) -->
    <div id="account-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-6 rounded-2xl border border-white/10 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-white">Nova Conta / Corretora</h3>
                <button onclick="closeModal('account-modal')" class="text-secondary hover:text-white">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="account-form" onsubmit="saveAccount(event)" class="space-y-4">
                <input type="hidden" id="account-id">
                
                <div>
                    <label class="block text-xs font-medium text-secondary mb-1">Nome da Corretora / Conta</label>
                    <input type="text" id="account-name" required class="w-full bg-background border border-border rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary" placeholder="Ex: IC Markets - Conta 01">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-secondary mb-1">Saldo Inicial (USD)</label>
                        <input type="number" id="account-initial" step="0.01" required class="w-full bg-background border border-border rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-secondary mb-1">Aportes Totais (USD)</label>
                        <input type="number" id="account-deposits" step="0.01" value="0" class="w-full bg-background border border-border rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary">
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeModal('account-modal')" class="px-4 py-2 text-sm font-medium text-gray-300 hover:text-white">Cancelar</button>
                    <button type="submit" class="bg-primary hover:bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-lg shadow-primary/20">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Goal Modal (NEW) -->
    <div id="goal-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm p-6 rounded-2xl border border-white/10 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-4">Definir Meta</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-secondary mb-1">Meta de Patrimônio (USD)</label>
                    <input type="number" id="goal-input" class="w-full bg-background border border-border rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary">
                </div>
                <button onclick="saveGoal()" class="w-full bg-primary hover:bg-blue-600 text-white font-bold py-2 rounded-lg shadow-lg shadow-primary/20">Salvar Meta</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const defaultRobots = [
            {
                id: '1',
                name: 'Robô Scalper X',
                color: '#3b82f6',
                configs: [
                    { lot: '0.01', timeframe: 'M5' }
                ],
                description: 'Estratégia agressiva em M5',
                data: [
                    { month: 'Jan', investment: 1000, profit: 150, winRate: 65, trades: 45 },
                    { month: 'Fev', investment: 1150, profit: 180, winRate: 68, trades: 42 },
                    { month: 'Mar', investment: 1330, profit: -50, winRate: 45, trades: 30 },
                    { month: 'Abr', investment: 1280, profit: 200, winRate: 70, trades: 50 },
                ]
            },
            {
                id: '2',
                name: 'Robô Trend Follower',
                color: '#8b5cf6',
                configs: [
                    { lot: '0.05', timeframe: 'H1' }
                ],
                description: 'Operações de médio prazo',
                data: [
                    { month: 'Jan', investment: 2000, profit: 100, winRate: 55, trades: 20 },
                    { month: 'Fev', investment: 2100, profit: 120, winRate: 60, trades: 18 },
                    { month: 'Mar', investment: 2220, profit: 150, winRate: 62, trades: 22 },
                    { month: 'Abr', investment: 2370, profit: 180, winRate: 65, trades: 15 },
                ]
            }
        ];

        // Migration helper for old data structure
        function migrateData(data) {
            if (!Array.isArray(data)) return defaultRobots;
            return data.map(robot => {
                if (!robot.configs) {
                    robot.configs = [];
                    if (robot.lot || robot.timeframe) {
                        robot.configs.push({
                            lot: robot.lot || '',
                            timeframe: robot.timeframe || 'M5'
                        });
                    }
                    delete robot.lot;
                    delete robot.timeframe;
                }
                return robot;
            });
        }

        let robots = [];
        let accounts = [];
        let wealthGoal = 100000;

        try {
            const storedRobots = localStorage.getItem('robots');
            robots = storedRobots ? migrateData(JSON.parse(storedRobots)) : defaultRobots;
            
            const storedAccounts = localStorage.getItem('accounts');
            accounts = storedAccounts ? JSON.parse(storedAccounts) : [];

            const storedGoal = localStorage.getItem('wealthGoal');
            if (storedGoal) wealthGoal = parseFloat(storedGoal);

        } catch (e) {
            console.error('Erro ao carregar dados:', e);
            robots = defaultRobots;
        }

        let selectedRobotIds = [];
        try {
            selectedRobotIds = JSON.parse(localStorage.getItem('selectedRobotIds')) || [robots[0].id];
        } catch (e) {
            selectedRobotIds = [robots[0].id];
        }

        let dollarRate = parseFloat(localStorage.getItem('dollarRate')) || 5.00;
        let euroRate = parseFloat(localStorage.getItem('euroRate')) || 5.50;
        let editingRobotId = null;
        let isAdminAuthenticated = false;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Robots data loaded:", robots);
            console.log("Default robots structure:", defaultRobots);
            
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('pt-BR');
            document.getElementById('dollar-rate').value = dollarRate.toFixed(2);
            document.getElementById('euro-rate').value = euroRate.toFixed(2);
            
            renderSidebar();
            updateDashboard();
            
            // Auto update rates
            updateRates();
        });

        // --- MOBILE SIDEBAR ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function closeSidebarMobile() {
            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('overlay');
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
        }

        // --- NAVIGATION ---
        function showPage(pageId) {
            document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active', 'text-white', 'border-r-4', 'border-primary', 'bg-primary/10'));
            const activeLink = document.getElementById(`nav-${pageId}`);
            if(activeLink) activeLink.classList.add('active');

            const titles = {
                'dashboard': 'Dashboard Geral',
                'wealth': 'Gestão de Patrimônio',
                'results': 'Resultados Consolidados',
                'admin': 'Administração do Sistema'
            };
            document.getElementById('page-title').textContent = titles[pageId];

            // Force chart resize/update when switching tabs
            if (pageId === 'dashboard') {
                setTimeout(updateDashboard, 100);
            }
            if (pageId === 'wealth') {
                setTimeout(updateWealth, 100);
            }
            if (pageId === 'results') {
                updateResults();
            }
            if (pageId === 'admin') {
                renderAdminList();
            }
        }

        // --- AUTHENTICATION ---
        function checkAdminAccess() {
            if (isAdminAuthenticated) {
                showPage('admin');
            } else {
                openModal('login-modal');
                document.getElementById('admin-password').value = '';
                document.getElementById('login-error').classList.add('hidden');
                document.getElementById('admin-password').focus();
            }
        }

        function verifyPassword() {
            const password = document.getElementById('admin-password').value;
            if (password === 'admin123') {
                isAdminAuthenticated = true;
                closeModal('login-modal');
                showPage('admin');
            } else {
                document.getElementById('login-error').classList.remove('hidden');
                document.getElementById('admin-password').classList.add('border-danger');
            }
        }

        // --- SIDEBAR LOGIC ---
        function renderSidebar() {
            const container = document.getElementById('robot-list');
            container.innerHTML = '';

            robots.forEach(robot => {
                const isSelected = selectedRobotIds.includes(robot.id);
                const div = document.createElement('div');
                div.className = `px-4 py-2 flex items-center justify-between cursor-pointer hover:bg-white/5 transition-colors ${isSelected ? 'bg-white/5' : ''}`;
                div.onclick = () => toggleRobotSelection(robot.id);
                
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full shadow-sm" style="background-color: ${robot.color}"></div>
                        <span class="text-sm text-gray-300 ${isSelected ? 'font-medium text-white' : ''}">${robot.name}</span>
                    </div>
                    ${isSelected ? '<i class="fa-solid fa-check text-primary text-xs"></i>' : ''}
                `;
                container.appendChild(div);
            });
        }

        function toggleRobotSelection(id) {
            if (selectedRobotIds.includes(id)) {
                if (selectedRobotIds.length > 1) {
                    selectedRobotIds = selectedRobotIds.filter(rid => rid !== id);
                }
            } else {
                selectedRobotIds.push(id);
            }
            localStorage.setItem('selectedRobotIds', JSON.stringify(selectedRobotIds));
            renderSidebar();
            updateDashboard();
        }

        // --- DASHBOARD LOGIC ---
        function updateDashboard() {
            console.log("updateDashboard called, selected robots:", selectedRobotIds);
            try {
                const selectedRobots = robots.filter(r => selectedRobotIds.includes(r.id));
                console.log("Selected robots data:", selectedRobots);
                
                // Calculate KPIs
                let totalProfit = 0;
                let totalInvestment = 0;
                let totalTrades = 0;
                let weightedWinRate = 0;

                selectedRobots.forEach(robot => {
                    if (robot.data && Array.isArray(robot.data)) {
                        robot.data.forEach(d => {
                            totalProfit += (d.profit || 0);
                            totalInvestment += (d.investment || 0);
                            totalTrades += (d.trades || 0);
                            weightedWinRate += ((d.winRate || 0) * (d.trades || 0));
                        });
                    }
                });

                const avgWinRate = totalTrades > 0 ? (weightedWinRate / totalTrades) : 0;
                const roi = totalInvestment > 0 ? ((totalProfit / totalInvestment) * 100) : 0;
                const profitBRL = totalProfit * dollarRate;

                // Update DOM
                document.getElementById('kpi-profit').textContent = formatUSD(totalProfit);
                document.getElementById('kpi-profit-brl').textContent = formatBRL(profitBRL);
                document.getElementById('kpi-investment').textContent = formatUSD(totalInvestment);
                // REMOVED: document.getElementById('kpi-roi').textContent = roi.toFixed(2) + '%';
                document.getElementById('kpi-winrate').textContent = avgWinRate.toFixed(1) + '%';
                
                const profitEl = document.getElementById('kpi-profit');
                profitEl.className = `text-2xl font-bold mt-1 ${totalProfit >= 0 ? 'text-success' : 'text-danger'}`;

                // Render Table synchronously
                renderTable(selectedRobots);

                // Render Charts with delay to ensure DOM readiness
                setTimeout(() => {
                    // Forçar reflow para garantir que os canvas estão visíveis
                    if (document.getElementById('profitChart')) {
                        document.getElementById('profitChart').offsetHeight;
                    }
                    renderCharts(selectedRobots);
                }, 100);

            } catch (error) {
                console.error("Erro ao atualizar dashboard:", error);
            }
        }

        // Variáveis globais para armazenar instâncias dos gráficos
        let profitChartInstance = null;
        let roiChartInstance = null;
        let rankingChartInstance = null;
        let scatterChartInstance = null;
        let wealthProjectionInstance = null;
        let houseMoneyInstance = null;

        function renderCharts(selectedRobots) {
            try {
                // Check if dashboard page is active AND canvas elements exist
                const dashboardPage = document.getElementById('page-dashboard');
                if (!dashboardPage || dashboardPage.classList.contains('hidden')) {
                    return;
                }
                
                const ctxProfit = document.getElementById('profitChart');
                const ctxRoi = document.getElementById('roiChart');
                
                // Verifique se os elementos canvas realmente existem no DOM
                if (!ctxProfit || !ctxProfit.getContext || !ctxRoi || !ctxRoi.getContext) {
                    console.warn("Canvas elements not ready or not found");
                    return;
                }
                
                // Verifique se há dados para mostrar
                if (!selectedRobots || selectedRobots.length === 0) {
                    console.warn("No robots selected for charts");
                    return;
                }

                // 1. Destruir instâncias antigas se existirem
                if (profitChartInstance) {
                    profitChartInstance.destroy();
                    profitChartInstance = null;
                }
                if (roiChartInstance) {
                    roiChartInstance.destroy();
                    roiChartInstance = null;
                }

                // 3. Preparar Dados
                let allMonths = [];
                selectedRobots.forEach(r => {
                    if(r.data) r.data.forEach(d => {
                        if(!allMonths.includes(d.month)) allMonths.push(d.month);
                    });
                });
                
                if (allMonths.length === 0) allMonths = ['Sem Dados'];

                // Profit Chart Data
                const profitDatasets = selectedRobots.map(robot => {
                    return {
                        label: robot.name,
                        data: allMonths.map(m => {
                            const d = (robot.data || []).find(x => x.month === m);
                            return d ? parseFloat(d.profit || 0) : 0;
                        }),
                        borderColor: robot.color,
                        backgroundColor: hexToRgba(robot.color, 0.2),
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    };
                });

                // ROI Chart Data
                const roiDatasets = selectedRobots.map(r => {
                    const totalInv = (r.data || []).reduce((acc, cur) => acc + parseFloat(cur.investment || 0), 0);
                    const totalProf = (r.data || []).reduce((acc, cur) => acc + parseFloat(cur.profit || 0), 0);
                    const roi = totalInv > 0 ? (totalProf / totalInv) * 100 : 0;
                    return {
                        label: r.name,
                        data: [roi],
                        backgroundColor: r.color,
                        borderColor: r.color,
                        borderWidth: 1
                    };
                });

                // 4. Criar Novos Gráficos
                profitChartInstance = new Chart(ctxProfit, {
                    type: 'line',
                    data: {
                        labels: allMonths,
                        datasets: profitDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#9ca3af', font: { family: 'Inter' } }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(26, 26, 26, 0.9)',
                                titleColor: '#fff',
                                bodyColor: '#ccc',
                                borderColor: 'rgba(255,255,255,0.1)',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            y: {
                                grid: { color: '#262626' },
                                ticks: { color: '#9ca3af', callback: function(value) { return '$' + value; } }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#9ca3af' }
                            }
                        }
                    }
                });

                roiChartInstance = new Chart(ctxRoi, {
                    type: 'bar',
                    data: {
                        labels: ['ROI Total'],
                        datasets: roiDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { color: '#9ca3af' } }
                        },
                        scales: {
                            y: {
                                grid: { color: '#262626' },
                                ticks: { color: '#9ca3af', callback: function(value) { return value + '%'; } }
                            },
                            x: { display: false }
                        }
                    }
                });

            } catch (error) {
                console.error("Erro fatal ao renderizar gráficos:", error);
            }
        }

        function renderTable(selectedRobots) {
            try {
                const tbody = document.getElementById('dashboard-table-body');
                if (!tbody) {
                    console.warn("Tabela não encontrada no DOM");
                    return;
                }
                
                tbody.innerHTML = '';

                if (selectedRobots.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="7" class="px-6 py-8 text-center text-secondary">
                            Nenhum robô selecionado. Selecione robôs na barra lateral.
                        </td>
                    `;
                    tbody.appendChild(tr);
                    return;
                }

                selectedRobots.forEach(robot => {
                    const configStr = (robot.configs && robot.configs.length > 0) 
                        ? robot.configs.map(c => `${c.lot || '-'} (${c.timeframe || '-'})`).join(', ')
                        : 'N/A';

                    if (robot.data && Array.isArray(robot.data)) {
                        robot.data.forEach(d => {
                            const investment = parseFloat(d.investment || 0);
                            const profit = parseFloat(d.profit || 0);
                            const roi = investment > 0 ? (profit / investment) * 100 : 0;
                            
                            const tr = document.createElement('tr');
                            tr.className = 'hover:bg-white/5 transition-colors';
                            tr.innerHTML = `
                                <td class="px-6 py-4 font-medium text-white flex items-center gap-2">
                                    <div class="w-2 h-2 rounded-full" style="background-color: ${robot.color}"></div>
                                    ${robot.name}
                                </td>
                                <td class="px-6 py-4 text-secondary text-xs">
                                    <span class="bg-white/5 px-2 py-1 rounded border border-white/10">${configStr}</span>
                                </td>
                                <td class="px-6 py-4 text-secondary">${d.month || '-'}</td>
                                <td class="px-6 py-4 text-right text-gray-300">${formatUSD(investment)}</td>
                                <td class="px-6 py-4 text-right font-medium ${profit >= 0 ? 'text-success' : 'text-danger'}">${formatUSD(profit)}</td>
                                <td class="px-6 py-4 text-right text-gray-300">${roi.toFixed(2)}%</td>
                                <td class="px-6 py-4 text-center">
                                    <span class="px-2 py-1 rounded text-xs font-medium ${(d.winRate || 0) > 60 ? 'bg-success/10 text-success' : 'bg-warning/10 text-warning'}">
                                        ${d.winRate || 0}%
                                    </span>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                });
            } catch (error) {
                console.error("Erro ao renderizar tabela:", error);
            }
        }

        // --- WEALTH MANAGEMENT LOGIC (NEW) ---
        function updateWealth() {
            // Calculate Totals
            let totalRobotProfit = 0;
            robots.forEach(r => {
                if(r.data) r.data.forEach(d => totalRobotProfit += parseFloat(d.profit || 0));
            });

            let totalDeposits = accounts.reduce((acc, cur) => acc + parseFloat(cur.deposits || 0), 0);
            let totalInitial = accounts.reduce((acc, cur) => acc + parseFloat(cur.initial || 0), 0);
            
            // Total Wealth = Initial + Deposits + Profits
            // Note: In a real scenario, profit is already inside the account balance, but here we sum them for simplicity
            // Assuming "Initial" + "Deposits" is the "Pocket Money" and "Profit" is the gain.
            // If user updates account balance manually, we should use that. But let's calculate derived wealth.
            
            // Simplified Model: Wealth = (Sum of Account Initial + Deposits) + Total Robot Profit
            const currentWealth = totalInitial + totalDeposits + totalRobotProfit;
            const pocketMoney = totalInitial + totalDeposits;

            // Update Header
            document.getElementById('wealth-total').textContent = formatUSD(currentWealth);
            document.getElementById('wealth-total-brl').textContent = formatBRL(currentWealth * dollarRate);

            // Update Goal
            document.getElementById('goal-target-display').textContent = formatUSD(wealthGoal);
            document.getElementById('goal-current').textContent = formatUSD(currentWealth);
            const progress = Math.min((currentWealth / wealthGoal) * 100, 100);
            document.getElementById('goal-progress-bar').style.width = `${progress}%`;
            document.getElementById('goal-percentage').textContent = `${progress.toFixed(1)}%`;

            // Render Accounts Table
            const tbody = document.getElementById('wealth-accounts-body');
            tbody.innerHTML = '';
            accounts.forEach((acc, index) => {
                // Estimate profit share per account (simplified: proportional split or just placeholder)
                // Ideally we would link robots to accounts, but for now let's keep it simple
                const accProfit = 0; // Placeholder, as we don't link robots to accounts yet
                const currentBal = parseFloat(acc.initial) + parseFloat(acc.deposits); // + profit

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-white">${acc.name}</td>
                    <td class="px-6 py-4 text-right text-secondary">${formatUSD(acc.initial)}</td>
                    <td class="px-6 py-4 text-right text-secondary">${formatUSD(acc.deposits)}</td>
                    <td class="px-6 py-4 text-right text-success font-bold">Auto-calc*</td>
                    <td class="px-6 py-4 text-right text-white font-bold">${formatUSD(currentBal)} + Lucro</td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="deleteAccount(${index})" class="text-danger hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Render Wealth Charts
            setTimeout(() => renderWealthCharts(currentWealth, pocketMoney, totalRobotProfit), 100);
        }

        function renderWealthCharts(currentWealth, pocketMoney, totalProfit) {
            // Check if wealth page is active before rendering
            const wealthPage = document.getElementById('page-wealth');
            if (!wealthPage || wealthPage.classList.contains('hidden')) {
                return; // Do not render if not visible
            }

            if (wealthProjectionInstance) {
                wealthProjectionInstance.destroy();
                wealthProjectionInstance = null;
            }
            if (houseMoneyInstance) {
                houseMoneyInstance.destroy();
                houseMoneyInstance = null;
            }

            const ctxProj = document.getElementById('wealthProjectionChart');
            const ctxHouse = document.getElementById('houseMoneyChart');

            if (!ctxProj || !ctxProj.getContext || !ctxHouse || !ctxHouse.getContext) return;

            // Projection Data (Compound Interest)
            const months = ['Atual', '+1 Mês', '+2 Meses', '+3 Meses', '+6 Meses', '+12 Meses'];
            const rate = 0.05; // 5% monthly
            const projected = [currentWealth];
            for(let i=1; i<13; i++) {
                projected.push(projected[i-1] * (1 + rate));
            }
            const plotData = [
                currentWealth, 
                projected[1], 
                projected[2], 
                projected[3], 
                projected[6], 
                projected[12]
            ];

            wealthProjectionInstance = new Chart(ctxProj, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Projeção (5% a.m.)',
                        data: plotData,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#262626' }, ticks: { color: '#9ca3af', callback: v => '$' + v } },
                        x: { grid: { display: false }, ticks: { color: '#9ca3af' } }
                    }
                }
            });

            // House Money Chart (Doughnut)
            houseMoneyInstance = new Chart(ctxHouse, {
                type: 'doughnut',
                data: {
                    labels: ['Seu Bolso (Risco)', 'Lucro (House Money)'],
                    datasets: [{
                        data: [pocketMoney, totalProfit],
                        backgroundColor: ['#3b82f6', '#22c55e'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#9ca3af' } }
                    },
                    cutout: '70%'
                }
            });
        }

        function saveAccount(e) {
            e.preventDefault();
            const name = document.getElementById('account-name').value;
            const initial = document.getElementById('account-initial').value;
            const deposits = document.getElementById('account-deposits').value;

            accounts.push({ name, initial, deposits });
            localStorage.setItem('accounts', JSON.stringify(accounts));
            
            closeModal('account-modal');
            updateWealth();
        }

        function deleteAccount(index) {
            if(confirm('Remover esta conta?')) {
                accounts.splice(index, 1);
                localStorage.setItem('accounts', JSON.stringify(accounts));
                updateWealth();
            }
        }

        function editGoal() {
            openModal('goal-modal');
            document.getElementById('goal-input').value = wealthGoal;
        }

        function saveGoal() {
            const val = parseFloat(document.getElementById('goal-input').value);
            if(val > 0) {
                wealthGoal = val;
                localStorage.setItem('wealthGoal', wealthGoal);
                closeModal('goal-modal');
                updateWealth();
            }
        }

        // --- RESULTS LOGIC ---
        function updateResults() {
            try {
                const performance = robots.map(r => {
                    const totalInv = (r.data || []).reduce((acc, cur) => acc + parseFloat(cur.investment || 0), 0);
                    const totalProf = (r.data || []).reduce((acc, cur) => acc + parseFloat(cur.profit || 0), 0);
                    const totalTrades = (r.data || []).reduce((acc, cur) => acc + parseFloat(cur.trades || 0), 0);
                    const weightedWinRate = (r.data || []).reduce((acc, cur) => acc + ((cur.winRate || 0) * (cur.trades || 0)), 0);
                    
                    return {
                        ...r,
                        totalProfit: totalProf,
                        roi: totalInv > 0 ? (totalProf / totalInv) * 100 : 0,
                        avgWinRate: totalTrades > 0 ? (weightedWinRate / totalTrades) : 0
                    };
                }).sort((a, b) => b.totalProfit - a.totalProfit);

                const container = document.getElementById('top-robots-container');
                if (container) {
                    container.innerHTML = '';
                    
                    const top3 = performance.slice(0, 3);
                    const medals = ['🥇', '🥈', '🥉'];
                    const podiumOrder = [top3[1], top3[0], top3[2]].filter(Boolean);

                    podiumOrder.forEach((robot, index) => {
                        const isFirst = robot === top3[0];
                        const medal = medals[performance.indexOf(robot)];
                        
                        const card = document.createElement('div');
                        card.className = `glass-panel rounded-xl p-6 flex flex-col items-center justify-center relative ${isFirst ? 'border-2 border-yellow-500 shadow-xl shadow-yellow-500/10 transform -translate-y-4' : ''}`;
                        card.innerHTML = `
                            <div class="absolute -top-4 bg-surface border border-border rounded-full w-10 h-10 flex items-center justify-center text-xl shadow-lg">
                                ${medal}
                            </div>
                            <div class="w-16 h-16 rounded-full mb-4 flex items-center justify-center text-2xl shadow-lg" style="background-color: ${robot.color}20; color: ${robot.color}">
                                <i class="fa-solid fa-robot"></i>
                            </div>
                            <h3 class="font-bold text-white text-lg mb-1">${robot.name}</h3>
                            <p class="text-success font-bold text-xl mb-4">${formatUSD(robot.totalProfit)}</p>
                            
                            <div class="w-full grid grid-cols-2 gap-2 text-center text-xs">
                                <div class="bg-white/5 rounded p-2">
                                    <div class="text-secondary">ROI</div>
                                    <div class="font-medium text-white">${robot.roi.toFixed(1)}%</div>
                                </div>
                                <div class="bg-white/5 rounded p-2">
                                    <div class="text-secondary">Win Rate</div>
                                    <div class="font-medium text-white">${robot.avgWinRate.toFixed(1)}%</div>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                }

                setTimeout(() => renderResultsCharts(performance), 100);

            } catch (error) {
                console.error("Erro ao atualizar resultados:", error);
            }
        }

        function renderResultsCharts(performance) {
            try {
                const resultsPage = document.getElementById('page-results');
                if (!resultsPage || resultsPage.classList.contains('hidden')) {
                    return;
                }

                const ctxRanking = document.getElementById('rankingChart');
                const ctxScatter = document.getElementById('scatterChart');

                if (!ctxRanking || !ctxRanking.getContext || !ctxScatter || !ctxScatter.getContext) return;

                if (rankingChartInstance) {
                    rankingChartInstance.destroy();
                    rankingChartInstance = null;
                }
                if (scatterChartInstance) {
                    scatterChartInstance.destroy();
                    scatterChartInstance = null;
                }

                rankingChartInstance = new Chart(ctxRanking, {
                    type: 'bar',
                    data: {
                        labels: performance.map(r => r.name),
                        datasets: [{
                            label: 'Lucro Total (USD)',
                            data: performance.map(r => r.totalProfit),
                            backgroundColor: performance.map(r => r.color),
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: '#262626' }, ticks: { color: '#9ca3af' } },
                            y: { grid: { display: false }, ticks: { color: '#e5e5e5' } }
                        }
                    }
                });

                scatterChartInstance = new Chart(ctxScatter, {
                    type: 'scatter',
                    data: {
                        datasets: performance.map(r => ({
                            label: r.name,
                            data: [{ x: r.avgWinRate, y: r.roi }],
                            backgroundColor: r.color,
                            pointRadius: 8,
                            pointHoverRadius: 10
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'bottom', labels: { color: '#9ca3af' } },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `${ctx.dataset.label}: Win ${ctx.raw.x}% / ROI ${ctx.raw.y.toFixed(1)}%`
                                }
                            }
                        },
                        scales: {
                            x: { 
                                title: { display: true, text: 'Win Rate (%)', color: '#64748b' },
                                grid: { color: '#262626' }, 
                                ticks: { color: '#9ca3af' } 
                            },
                            y: { 
                                title: { display: true, text: 'ROI (%)', color: '#64748b' },
                                grid: { color: '#262626' }, 
                                ticks: { color: '#9ca3af' } 
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Erro ao renderizar gráficos de resultados:", error);
            }
        }

        // --- ADMIN LOGIC ---
        function renderAdminList() {
            const container = document.getElementById('admin-list');
            container.innerHTML = '';

            robots.forEach(robot => {
                const div = document.createElement('div');
                div.className = 'glass-panel p-4 rounded-lg flex items-center justify-between';
                
                const configStr = (robot.configs && robot.configs.length > 0) 
                        ? robot.configs.map(c => `${c.lot || '-'} (${c.timeframe || '-'})`).join(', ')
                        : 'N/A';

                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl" style="background-color: ${robot.color}20; color: ${robot.color}">
                            <i class="fa-solid fa-robot"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-white">${robot.name}</h4>
                            <p class="text-xs text-secondary">${configStr}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editRobot('${robot.id}')" class="p-2 text-primary hover:bg-primary/10 rounded transition-colors">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button onclick="deleteRobot('${robot.id}')" class="p-2 text-danger hover:bg-danger/10 rounded transition-colors">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            if(id === 'robot-modal') {
                document.getElementById('robot-form').reset();
                editingRobotId = null;
                document.getElementById('modal-title').textContent = 'Novo Robô';
                document.getElementById('configs-container').innerHTML = '';
                document.getElementById('data-rows').innerHTML = '';
            }
        }

        function addConfigRow(lot = '', timeframe = '') {
            const container = document.getElementById('configs-container');
            const div = document.createElement('div');
            div.className = 'grid grid-cols-2 gap-2 mb-2';
            div.innerHTML = `
                <input type="text" placeholder="Lote (Ex: 0.01)" value="${lot}" class="config-lot bg-background border border-border rounded px-3 py-1 text-sm text-white focus:outline-none focus:border-primary">
                <div class="flex gap-2">
                    <select class="config-tf bg-background border border-border rounded px-3 py-1 text-sm text-white focus:outline-none focus:border-primary w-full">
                        <option value="M1" ${timeframe === 'M1' ? 'selected' : ''}>M1</option>
                        <option value="M5" ${timeframe === 'M5' ? 'selected' : ''}>M5</option>
                        <option value="M15" ${timeframe === 'M15' ? 'selected' : ''}>M15</option>
                        <option value="M30" ${timeframe === 'M30' ? 'selected' : ''}>M30</option>
                        <option value="H1" ${timeframe === 'H1' ? 'selected' : ''}>H1</option>
                        <option value="H4" ${timeframe === 'H4' ? 'selected' : ''}>H4</option>
                        <option value="D1" ${timeframe === 'D1' ? 'selected' : ''}>D1</option>
                    </select>
                    <button type="button" onclick="this.parentElement.parentElement.remove()" class="text-danger hover:text-red-400 px-2">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
        }

        function addDataRow(data = {}) {
            const container = document.getElementById('data-rows');
            const div = document.createElement('div');
            div.className = 'grid grid-cols-5 gap-2 mb-2 items-center';
            div.innerHTML = `
                <input type="text" placeholder="Mês" value="${data.month || ''}" class="data-month bg-background border border-border rounded px-2 py-1 text-xs text-white w-full">
                <input type="number" placeholder="Inv." value="${data.investment || ''}" class="data-inv bg-background border border-border rounded px-2 py-1 text-xs text-white w-full">
                <input type="number" placeholder="Lucro" value="${data.profit || ''}" class="data-profit bg-background border border-border rounded px-2 py-1 text-xs text-white w-full">
                <input type="number" placeholder="Win%" value="${data.winRate || ''}" class="data-win bg-background border border-border rounded px-2 py-1 text-xs text-white w-full">
                <div class="flex gap-1">
                    <input type="number" placeholder="Trades" value="${data.trades || ''}" class="data-trades bg-background border border-border rounded px-2 py-1 text-xs text-white w-full">
                    <button type="button" onclick="this.parentElement.parentElement.remove()" class="text-danger hover:text-red-400">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            `;
            container.appendChild(div);
        }

        function saveRobot(e) {
            e.preventDefault();
            
            const name = document.getElementById('robot-name').value;
            const color = document.getElementById('robot-color').value;
            const desc = document.getElementById('robot-desc').value;
            
            // Collect Configs
            const configs = [];
            document.querySelectorAll('#configs-container > div').forEach(row => {
                const lot = row.querySelector('.config-lot').value;
                const tf = row.querySelector('.config-tf').value;
                if(lot) configs.push({ lot, timeframe: tf });
            });

            // Collect Data
            const data = [];
            document.querySelectorAll('#data-rows > div').forEach(row => {
                data.push({
                    month: row.querySelector('.data-month').value,
                    investment: parseFloat(row.querySelector('.data-inv').value) || 0,
                    profit: parseFloat(row.querySelector('.data-profit').value) || 0,
                    winRate: parseFloat(row.querySelector('.data-win').value) || 0,
                    trades: parseFloat(row.querySelector('.data-trades').value) || 0
                });
            });

            if (editingRobotId) {
                const index = robots.findIndex(r => r.id === editingRobotId);
                if (index !== -1) {
                    robots[index] = { ...robots[index], name, color, description: desc, configs, data };
                }
            } else {
                const newRobot = {
                    id: Date.now().toString(),
                    name,
                    color,
                    description: desc,
                    configs,
                    data
                };
                robots.push(newRobot);
                selectedRobotIds.push(newRobot.id);
            }

            localStorage.setItem('robots', JSON.stringify(robots));
            localStorage.setItem('selectedRobotIds', JSON.stringify(selectedRobotIds));
            
            closeModal('robot-modal');
            renderAdminList();
            renderSidebar();
            updateDashboard();
        }

        function editRobot(id) {
            const robot = robots.find(r => r.id === id);
            if (!robot) return;

            editingRobotId = id;
            document.getElementById('modal-title').textContent = 'Editar Robô';
            document.getElementById('robot-name').value = robot.name;
            document.getElementById('robot-color').value = robot.color;
            document.getElementById('robot-desc').value = robot.description || '';
            
            const configContainer = document.getElementById('configs-container');
            configContainer.innerHTML = '';
            if(robot.configs && robot.configs.length > 0) {
                robot.configs.forEach(c => addConfigRow(c.lot, c.timeframe));
            } else {
                addConfigRow();
            }

            const dataContainer = document.getElementById('data-rows');
            dataContainer.innerHTML = '';
            if (robot.data) {
                robot.data.forEach(d => addDataRow(d));
            }

            openModal('robot-modal');
        }

        function deleteRobot(id) {
            if (confirm('Tem certeza que deseja excluir este robô?')) {
                robots = robots.filter(r => r.id !== id);
                selectedRobotIds = selectedRobotIds.filter(rid => rid !== id);
                
                localStorage.setItem('robots', JSON.stringify(robots));
                localStorage.setItem('selectedRobotIds', JSON.stringify(selectedRobotIds));
                
                renderAdminList();
                renderSidebar();
                updateDashboard();
            }
        }

        // --- UTILS ---
        function formatUSD(value) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        }

        function formatBRL(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // --- RATES API ---
        async function updateRates() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();
                
                if (data && data.rates && data.rates.BRL) {
                    dollarRate = data.rates.BRL;
                    document.getElementById('dollar-rate').value = dollarRate.toFixed(2);
                    localStorage.setItem('dollarRate', dollarRate);
                    
                    // Estimate EUR based on USD
                    const eurToUsd = 1 / data.rates.EUR;
                    euroRate = dollarRate * eurToUsd; // Approximate
                    document.getElementById('euro-rate').value = euroRate.toFixed(2);
                    localStorage.setItem('euroRate', euroRate);
                    
                    updateDashboard();
                    updateWealth();
                }
            } catch (error) {
                console.error('Erro ao buscar cotação:', error);
            }
        }

        function manualUpdateRate(currency, value) {
            if (currency === 'usd') {
                dollarRate = parseFloat(value);
                localStorage.setItem('dollarRate', dollarRate);
            } else {
                euroRate = parseFloat(value);
                localStorage.setItem('euroRate', euroRate);
            }
            updateDashboard();
            updateWealth();
        }

        // --- BACKUP SYSTEM ---
        function exportData() {
            const data = {
                robots: robots,
                accounts: accounts,
                wealthGoal: wealthGoal,
                selectedRobotIds: selectedRobotIds,
                dollarRate: dollarRate,
                euroRate: euroRate,
                version: 'v6'
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "backup_robos_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.robots) {
                        robots = migrateData(data.robots);
                        localStorage.setItem('robots', JSON.stringify(robots));
                    }
                    if (data.accounts) {
                        accounts = data.accounts;
                        localStorage.setItem('accounts', JSON.stringify(accounts));
                    }
                    if (data.wealthGoal) {
                        wealthGoal = data.wealthGoal;
                        localStorage.setItem('wealthGoal', wealthGoal);
                    }
                    if (data.selectedRobotIds) {
                        selectedRobotIds = data.selectedRobotIds;
                        localStorage.setItem('selectedRobotIds', JSON.stringify(selectedRobotIds));
                    }
                    
                    alert('Dados restaurados com sucesso!');
                    location.reload(); // Reload to apply changes cleanly
                } catch (error) {
                    alert('Erro ao importar arquivo: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

    </script>
</body>
</html>
